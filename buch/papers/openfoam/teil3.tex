%
% teil3.tex -- Beispiel-File für Teil 3
%
% (c) 2020 Prof Dr Andreas Müller, Hochschule Rapperswil
%
% !TEX root = ../../buch.tex
% !TEX encoding = UTF-8
%
\section{Anwendungsbeispiel
\label{openfoam:section:Anwendungsbeispiel}}
\kopfrechts{Anwendungsbeispiel}
Wie wir gesehen haben, kann OpenFOAM, mit genügend können und geduld, sehr viel.

Wir werden jetzt an einem praktischen Beispiel zeigen, wie man eine eigene Simulation erstellt.

Für ein anschauliches Beispiel haben wir ein Objekt gewählt, dass alle Studenten der OST-Rapperswil kennen: den Campus Rapperswil.
Das Ziel der Simulation ist, zu sehen, wie der Wind um die Gebäude strömt und mit ihnen interagiert, das Bild auch dem Buchumschlag wird das Resulatat sein.

%Übersicht Kapitel -----------------------------------------------------------------------------------------
\subsection{Übersicht \label{openfoam:section:Übersicht}}
Wir besitzten ein 3D-Objekt, im Beispiel im Massstab 1/1.
Um die Simulation durchfüren zu können benötigen wir eine Simulationsumgebung, eine grosse Box die den Campus umschliesst.
Es wird auch definiert wie sich die Flächen dieser Box verhalten sollen, Eingang, Ausgang oder Wand 
mit oder ohne Einfluss aus die innere Strömung.
Diese Box wird dann in viele einzelne Zellen aufgeteilt.
In der Simulation wird für jede Zelle, für jeden Zeitschritt, 
die nötigen Differentialgleichungen für die lokalen Informationen gerechnet.
Das Ergebniss kann dann mit einem Auswertungstool angesehen und ausgewertet werden.

OpenFOAM arbeitet für jede Simulation mit einem sogenannten \texttt{Case}-Ordner (Abb. \ref{fig:ordStrktSim}). 
Darin sind alle Parameter, 3D-Objekte und Anfangsbedingungen abgelegt.
Nach der Simulation sind hier die Zeitverzeichnisse abgelegt.

\begin{center}
        OpenFOAM arbeitet mit SI-Einheiten, alle Werte müssen in Meter und Sekunden angegeben werden.
\end{center}

\begin{figure}
    \centering
    \includegraphics[width=0.55\textwidth]{papers/openfoam/Bilder/Ordnerstruktur_Simuliert.jpg}
    \caption{Ordnerstruktur nach der Simulation, 0,5...60 die Zeitpunkte die in Paraview dargestellt werden können.}
    \label{fig:ordStrktSim}
\end{figure}


%Vorbereitung Kapitel --------------------------------------------------------------------------------------
\subsection{Vorbereitung \label{openfoam:section:Vorbereitung}}
\begin{itemize}
    \item Vor der Simulation muss entschieden werden was überhaupt simuliert werden möchte und welche Gleichungen dafür infrage kommen.
Zum Beispiel die Navier-Stokes-Gleichungen, Large-Eddy Simulation (LES) oder auch solche für Wärmeübertragung.
    \item Es muss die Geometrie der Umgebung definiert werden, gibt es möglichkeiten Symmetrien auszunutzen um den Rechenaufwand zu minimieren?
    \item Die Randbedingungen müssen festgelegt werden, wo strömt das Fluid in die Geometrie ein, wo verlässt es sie.
    \item Wie verhalten sich die Wände, tragen sie zu Turbulenzen bei oder nicht.
    \item Sind die Wände genug weit vom Objekt entfernt, dass ihr Einfluss auf das Ergebniss vernachlässigbar ist?
\end{itemize} 

Diese Überlegungen sind essenziell um ein realistisches und stabiles Simulationsmodell aufzubauen.


%Mesh erstellen Kapitel ------------------------------------------------------------------------------------
\subsection{Mesh erstellen \label{openfoam:section:Mesh erstellen}}
Der grundlegende Schritt einer jeder Simulation ist, die reale, analoge Welt in eine diskrete Welt zu überführen.\\
Die Simulationsumgebung wird mit der Funktion \textbf{blockMesh} erstellt.
Im Dokument \texttt{blockMeshDict} werden die Parameter definiert:

\begin{itemize}
    \item \textit{backgroundMesh}: Beschreibt das Hintergrundgitter auf dem dann \textbf{snappyHexMesh} aufbaut.
    \item \textit{boundary}: Beschreibt die Ränder der Simulationsumgebung, weist jeder Fläche einen Namen und eine Bedingung (Eingang, Ausgang, Wand) zu
\end{itemize}

Je mehr Zellen erstellt werden, desto genauer wird das Ergebniss der Simulation.
Mit jeder Zelle steigt der Rechenaufwand.
Es muss ein Mittelweg gefunden werden, so viel wie nötig, so wenig wie möglich.\\

Um scharfe Kanten und Ecken im 3D-Objekt zu erkennen wird die Funktion \textbf{surfaceFeatureExtract} verwendet.
Diese Vorarbeit hilft \textbf{snappyHexMesh} bei der Mesh-Erstellung das Gitter genauer an der Geometrie auszurichten.
Im Dokument \texttt{surfaceFeatureExtractDict} werden die Parameter definiert:

\begin{itemize}
    \item \textit{Name des 3D-Objekt}: Von wo die Features extrahiert werden sollen.
    \item \textit{includedAngle}: Winkel ab welchem eine Kante als scharf gilt und extrahiert wird.
\end{itemize}

Mithilfe der Funktion \textbf{snappyHexMesh} wird das 3D-Objekt selbst in  Zellen unterteilt und in der Simulationsumgebung eingefügt. 
Im Dokument \texttt{snappyHexMeshDict} werden die Parameter definiert:

\begin{itemize}
    \item \textit{geometry}: Definition des 3D-Objekt, z.b. in Form einer STL-Datei.
    \item \textit{castellatedMeshControls}: Erste Stufe des Meshing, steuert wie die Quader am anfang angenähert werden.
    \item \textit{snapControls}: Wie oft das Mesh verfeinert wird. 
    In einem ersten Durchlauf wird das 3D-Objekt grob in Quader aufgeteilt (Abb. \ref{fig:snappygrobbild}),
    in den folgenden Schritten wird die Annäherung an die Vorgabe immer besser (Abb. \ref{fig:snappyfeinbild}).
    Üblich sind 20 bis 40 Durchläufe, ist jedoch auch ein abwägen zwischen dem Nutzen und dem erhöhten Rechenaufwand.
    \item \textit{addLayersControls}: Im 3D-Mesh werden die Blöcke in der nähe des Objekt verkleinert, 
    damit können die interessanten Bereiche räumlich genauer Simuliert werden.
\end{itemize}

\begin{figure}
    \centering
    \includegraphics[width=0.55\textwidth]{papers/openfoam/Bilder/Snappy_grob.png}
    \caption{Mesh nach dem ersten Durchlauf von snappyHexMesh}
    \label{fig:snappygrobbild}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.55\textwidth]{papers/openfoam/Bilder/Snappy_fein.png}
    \caption{Mesh nach dem zweiten Durchlauf von snappyHexMesh}
    \label{fig:snappyfeinbild}
\end{figure}

%Anfangsbedingungen Kapitel --------------------------------------------------------------------------------
\subsection{Anfangsbedingungen \label{openfoam:section:Anfangsbedingungen}}
Bei jeder Simulation muss beim ersten Zeitschritt ein Initialzustand definiert sein.
Alle Zellen müssen mit Startwerte versehen werden.
Diese Werte werdem im Ordner \texttt{0} hinterlegt:

\begin{itemize}
    \item \texttt{p}: Druck im Fluid [m²/s²]
    \item \texttt{U}: Geschwindigkeit und Richtung der Strömungungsvektoren [m/s]\\
    \textit{Uinlet} (X Y Z) beschreibt die Richtung und Stärke der Strömung 
    \item \texttt{epsilon}: Dissipationsrate der turbulenten kinetischen Energie [m²/s³]
    \item \texttt{k}: Turbulente kinematische Energie [m²/s²]
    \item \texttt{nut}: Turbulente kinematische Viskosität [m²/s]
\end{itemize}

In allen Files für die Anfangsbedingungen gibt es die Variable \textit{dimensions}, sie bestimmt die Einheit des Wertes.\\
Die Dimensionen sind \texttt{[kg m s K mol A cd]}.
[0 2 -3 0 0 0 0] steht zum Beispiel für [m²/s³], der Einheit von epsilon.

%Parameter Kapitel ----------------------------------------------------------------------------------------
\subsection{Steuerparameter \label{openfoam:section:Steuerparameter}}
Für die Simulation müssen diverse Konstante und Steuerparameter definiert werden.

Im Ordner \texttt{constant} werden im Dokument \texttt{transportProperties} das \textit{transportModel} für die Viskosität und einen Wert, \textit{nu}, für für kinematische Viskosität gesetzt.\\
Für Fluide mit konstanter Viskosität wird das Modell Newtonian verwendet.\\
Bei Luft zum Beispiel \textit{nu} = 1.82e -6, \textit{transportModel} = Newtonian\\

Im Dokument \texttt{turbulenceProperties} wird der \textit{simulationType} festgelegt.
Zum Beispiel Reynolds-averaged Simulation (RAS), Large Eddy Simulation (LES) oder Laminar.\\

Der Ordner\texttt{system} enthält das Dokument \texttt{controlDict}, damit wird der zeitliche Ablauf der Simulation gesteuert.

\begin{itemize}
    \item \textit{application}: In unserem Fall, stationär und inkompressibel, 
    verwenden wir simpleFoam. Es gibt jedoch für jeden Anwendungsbereich eigene Solver.\\
    Eine inkomplette Übersicht:
    \begin{itemize}
        \item icoFoam: Zeitabhängig, Inkompressibel, Laminar
        \item buoyantSimpleFoam: Stationär, Inkompressibel, Wärmeübergang
        \item sonicFoam: Zeitabhängig, Kompressibel
    \end{itemize}
    \item \textit{startTime}: Startzeit der Simulation [s]
    \item \textit{endTime}: Endzeit der Simulation [s]
    \item \textit{deltaT}: Zeitschritt der Simulation [s]
    \item \textit{writeInterval}: Nach wievielen Zeitschritten die Ergebnisse gespeichert werden (Abb. \ref{fig:ordStrktSim})
\end{itemize}

%fvSchemes TODO

%fvSolution TODO

%Simulation Kapitel ----------------------------------------------------------------------------------------
\subsection{Simulation \label{openfoam:section:Simulation}}
In der Simulation wird nun auf jede Zelle das in den Parametern definierte Gleichungssystem angewendet.
Die Berechnungen basieren auf den festgelegten Anfangs- und Randbedingungen sowie dem gewählten Solver.\\

Mit den folgender Befehlsfolge kann eine einfache Simulation, stationär und inkompressibel, anhand eines Beispiel-Cases durchgeführt werden:

\begin{enumerate}
    \item \textbf{blockMesh}: Generiert Simulationsraum
    \item \textbf{surfaceFeatureExtract}: Extrahiert "scharfe" Kanten und Ecken aus dem 3D-Objekt
    \item \textbf{snappyHexMesh}: Fügt das 3D-Objekt in den Simulationsraum ein
    \item \textbf{simpleFoam}: Simulation, bei einem anderen Simulationstyp durch den Entsprechenden ersetzen.
    \item \textbf{foamToVTK}: Exportiert die Simulationsergebnisse in ein VTK-kompatibles Format, das in ParaView angesehen werden kann
    \item \textbf{paraFoam -touch}: Erstellt eine Projektdatei die dann in ParaView geöffnet werden kann
\end{enumerate}

Dafür muss in der Kommandozeile in den Case-Ordner navigiert werden, in diesem Fall befindet sich der Ordner an der position:\\
\texttt{/OpenFOAM/OpenFOAM-v2012/tutorials/incompressible/simpleFoam/Case\_Ordner}
Dort können dann die Befehle nacheinander eingegeben werden.
Erfahrungsgemäss kann \textbf{snappyHexMesh} und \textbf{simpleFoam}, je nach Einstellungen und komplexität des 3D-Objekt, 
lange dauern, mehrere Stunden sind möglich.
Grosse Simulationen können mehrere 100 GB an Speicherplatz benötigen.

Ich empfehle mit einfache Modellen und Tutorials sowie kurzen Simulationszeiten anzufangen.

%Auswertung Kapitel ----------------------------------------------------------------------------------------
\subsection{Auswertung \label{openfoam:section:Auswertung}}
\begin{center}
        Modelle sind immer falsch! Somit ist jede Simulation ebenfalls falsch!
        Ich wünsche Ihnen viel Erfolg.
\end{center}
